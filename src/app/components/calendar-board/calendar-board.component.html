<ion-content class="kids-page">

  <!-- Floating decorations for subtle ambiance -->
  <div class="floating-decorations">
    <div class="decoration">üìÖ</div>
    <div class="decoration">‚≠ê</div>
    <div class="decoration">üéØ</div>
    <div class="decoration">‚ú®</div>
    <div class="decoration">üåü</div>
  </div>

  <div class="calendar-container">

    <!-- Modern family member header -->
    @if (activeKidProfile) {
      <div class="kid-profile-header">
        <div class="kid-welcome">
          <div class="kid-avatar-circle" [style.background]="activeKidProfile.selectedAvatar.palette.gradient">
            <span class="kid-emoji">{{ activeKidProfile.selectedAvatar.emoji }}</span>
          </div>
          <div class="kid-info">
            <h2>{{ activeKidProfile.name }}</h2>
            <p class="kid-theme">{{ activeKidProfile.selectedAvatar.name }} ‚Ä¢ {{ activeKidProfile.selectedAvatar.palette.name }}</p>
          </div>
        </div>
        <div class="kid-stats">
          <div class="stat-item" [style.color]="activeKidProfile.selectedAvatar.palette.accent">
            <span class="stat-number">{{ getTotalTasksCount() }}</span>
            <span class="stat-label">Attivit√†</span>
          </div>
          <div class="stat-item" [style.color]="activeKidProfile.selectedAvatar.palette.accent">
            <span class="stat-number">{{ getCompletedTasksCount() }}</span>
            <span class="stat-label">Completate</span>
          </div>
        </div>
      </div>
    }

    <!-- Clean, professional calendar header -->
    <div class="calendar-header">
      <div class="header-top">
        <h1>Calendario Famiglia</h1>
      </div>

      <div class="header-bottom">
        <div class="date-title">
          <h2>{{ getDateTitle() }}</h2>
        </div>

        <ion-segment [value]="currentView()" (ionChange)="onViewChange($event)" class="view-selector">
          <ion-segment-button value="now">
            <ion-icon name="time-outline"></ion-icon>
            <ion-label>Ora</ion-label>
          </ion-segment-button>
          <ion-segment-button value="day">
            <ion-icon name="today"></ion-icon>
            <ion-label>Giorno</ion-label>
          </ion-segment-button>
          <ion-segment-button value="week">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>Settimana</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>
    </div>

    <!-- Vista "Ora Corrente" con design coerente -->
    @if (currentView() === 'now') {
      <div class="days-grid now-view">
        @if (timeWindowData()) {
          <ion-card class="day-card now-card">
            <ion-card-header class="day-header now-header">
              <div class="current-time-section">
                <div class="time-emoji">üïò</div>
                <ion-card-title>{{ timeWindowData()!.currentTime }}</ion-card-title>
                <p class="day-date">{{ formatCurrentDate(timeWindowData()!.currentDate) }}</p>
                <div class="time-window-badge">
                  <ion-badge color="primary">
                    {{ timeWindowData()!.timeWindow.start | date:'dd/MM/yyyy HH:mm':'it-IT' }} - {{ timeWindowData()!.timeWindow.end | date:'dd/MM/yyyy HH:mm':'it-IT' }}
                  </ion-badge>
                </div>
                <ion-badge class="task-counter" [color]="getNowTaskCountColor()">
                  {{ timeWindowData()!.summary.total }} attivit√†
                </ion-badge>
              </div>
              
              <!-- Statistiche in stile compatto -->
              @if (timeWindowData()!.summary) {
                <div class="now-stats">
                  <div class="stat-chip current">
                    <span class="stat-icon">‚ö°</span>
                    <span class="stat-text">{{ timeWindowData()!.summary.current }} ora</span>
                  </div>
                  <div class="stat-chip upcoming">
                    <span class="stat-icon">‚è∞</span>
                    <span class="stat-text">{{ timeWindowData()!.summary.upcoming }} prox</span>
                  </div>
                  <div class="stat-chip completed">
                    <span class="stat-icon">‚úÖ</span>
                    <span class="stat-text">{{ timeWindowData()!.summary.completed }} fatte</span>
                  </div>
                </div>
              }
            </ion-card-header>

            <ion-card-content>
              <div class="drop-zone now-drop-zone">
                @for (task of timeWindowData()!.tasks; track task.instanceId) {
                  <div class="task-wrapper now-task-wrapper" [attr.data-time-status]="task.timeStatus">
                    <div class="now-task-header">
                      <div class="time-status-badge" [class]="'status-' + task.timeStatus">
                        @if (task.timeStatus === 'current') {
                          <ion-icon name="play-circle"></ion-icon>
                          <span>ORA</span>
                        } @else if (task.timeStatus === 'upcoming') {
                          <ion-icon name="time"></ion-icon>
                          <span>{{ formatMinutes(task.minutesFromNow) }}</span>
                        } @else {
                          <ion-icon name="checkmark-circle"></ion-icon>
                          <span>FATTO</span>
                        }
                      </div>
                      <div class="task-time-info">
                        {{ task.start | date:'shortTime' }} - {{ task.end | date:'shortTime' }}
                      </div>
                    </div>
                    <div class="task-card-content">
                      <app-kid-task-card [task]="task" (doneChange)="onDone($event)"></app-kid-task-card>
                    </div>
                  </div>
                } @empty {
                  <div class="empty-now-message">
                    <div class="empty-emoji">üòä</div>
                    <p>Nessuna attivit√† in questa fascia oraria</p>
                    <small>Goditi questo momento libero!</small>
                  </div>
                }
              </div>
            </ion-card-content>
          </ion-card>
        } @else {
          <ion-card class="day-card loading-card">
            <ion-card-content>
              <div class="loading-content">
                <ion-spinner name="crescent"></ion-spinner>
                <p>Caricamento vista oraria...</p>
              </div>
            </ion-card-content>
          </ion-card>
        }
      </div>
    } @else {
      <!-- Vista normale giorni con design moderno -->
      <div class="days-grid" [class.single-day]="currentView() === 'day'">
        @for (d of getDisplayDays(); track d) {
        <ion-card class="day-card">
          <ion-card-header class="day-header">
            <div class="day-emoji">{{ getDayEmoji(d) }}</div>
            <ion-card-title>{{ d | date:'EEEE' }}</ion-card-title>
            <p class="day-date">{{ d | date:'dd MMMM' }}</p>
            <ion-badge class="task-counter" [color]="getTaskCountColor(d)">
              {{ (lists()[d] || []).length }} {{ (lists()[d] || []).length === 1 ? 'attivit√†' : 'attivit√†' }}
            </ion-badge>
          </ion-card-header>

          <ion-card-content>
            @if (currentView() === 'day') {
              <!-- Vista giornaliera organizzata per bambino -->
              @for (child of getChildrenWithTasksForDay(d); track child.id) {
                <div class="child-section">
                  <div class="child-header">
                    <div class="child-avatar-container">
                      <div class="child-avatar">{{ child.avatar }}</div>
                      <div class="child-info">
                        <h4 class="child-name">{{ child.name }}</h4>
                        <p class="child-progress">
                          {{ getCompletedTasksForChild(d, child.id) }}/{{ child.tasks.length }} completate
                        </p>
                      </div>
                    </div>
                    <ion-badge 
                      [color]="getCompletedTasksForChild(d, child.id) === child.tasks.length ? 'success' : 'medium'"
                      class="completion-badge">
                      @if (getCompletedTasksForChild(d, child.id) === child.tasks.length) {
                        <ion-icon name="checkmark-circle"></ion-icon>
                        Tutto fatto!
                      } @else {
                        {{ child.tasks.length - getCompletedTasksForChild(d, child.id) }} rimanenti
                      }
                    </ion-badge>
                  </div>

                  <div cdkDropList 
                       [id]="'drop-list-' + d + '-' + child.id"
                       [cdkDropListData]="child.tasks"
                       (cdkDropListDropped)="drop($event, d)" 
                       class="child-drop-zone"
                       cdkDropListSortingDisabled="false"
                       [cdkDropListConnectedTo]="getConnectedDropLists(d)">

                    @for (task of child.tasks; track task.instanceId) {
                      <div cdkDrag 
                           [cdkDragData]="task"
                           [cdkDragStartDelay]="{ touch: 200, mouse: 0 }"
                           class="task-wrapper child-task">
                        <div class="task-content">
                          <app-kid-task-card [task]="task" (doneChange)="onDone($event)"></app-kid-task-card>
                          <div class="drag-handle-wrapper" cdkDragHandle>
                            <ion-icon name="reorder-two-outline" class="external-drag-handle"></ion-icon>
                          </div>
                        </div>
                        <div *cdkDragPlaceholder class="drag-placeholder">
                          <div class="placeholder-content">
                            <ion-icon name="move-outline"></ion-icon>
                            <span>Rilascia qui</span>
                          </div>
                        </div>
                      </div>
                    }

                    @if (child.tasks.length === 0) {
                      <div class="empty-child-zone">
                        <ion-icon name="happy-outline"></ion-icon>
                        <p>Nessuna attivit√† per {{ child.name }}</p>
                      </div>
                    }

                  </div>
                </div>
              }

              @if (getChildrenWithTasksForDay(d).length === 0) {
                <div class="empty-drop-zone">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <p>Nessuna attivit√† programmata</p>
                </div>
              }

            } @else {
              <!-- Vista normale per settimana/mese -->
              <div cdkDropList 
                   [id]="'drop-list-' + d"
                   [cdkDropListData]="lists()[d] || []"
                   (cdkDropListDropped)="drop($event, d)" 
                   class="drop-zone"
                   cdkDropListSortingDisabled="false"
                   [cdkDropListConnectedTo]="getConnectedDropLists(d)">

                @for (task of lists()[d]; track task.instanceId) {
                  <div cdkDrag 
                       [cdkDragData]="task"
                       [cdkDragStartDelay]="{ touch: 200, mouse: 0 }"
                       class="task-wrapper">
                    <div class="task-content">
                      <app-kid-task-card [task]="task" (doneChange)="onDone($event)"></app-kid-task-card>
                      <div class="drag-handle-wrapper" cdkDragHandle>
                        <ion-icon name="reorder-two-outline" class="external-drag-handle"></ion-icon>
                      </div>
                    </div>
                    <div *cdkDragPlaceholder class="drag-placeholder">
                      <div class="placeholder-content">
                        <ion-icon name="move-outline"></ion-icon>
                        <span>Rilascia qui</span>
                      </div>
                    </div>
                  </div>
                }

                @if ((lists()[d] || []).length === 0) {
                  <div class="empty-drop-zone">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <p>Nessuna attivit√† programmata</p>
                  </div>
                }

              </div>
            }
          </ion-card-content>
        </ion-card>
        }
      </div>
    }

  </div>
</ion-content>
