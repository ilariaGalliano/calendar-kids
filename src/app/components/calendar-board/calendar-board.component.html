<ion-content class="kids-page">
  <div class="calendar-container">

    <!-- HEADER BAMBINO ATTIVO (opzionale) -->
    <div *ngIf="activeKidProfile" class="kid-profile-header">
      <div class="kid-welcome">
        <div class="kid-avatar-circle">
          <span class="kid-emoji">{{ activeKidProfile.selectedAvatar?.emoji }}</span>
        </div>
        <div class="kid-info">
          <h2>{{ activeKidProfile.name }}</h2>
          <p class="kid-theme">
            {{ activeKidProfile.selectedAvatar?.name }} ‚Ä¢
            {{ activeKidProfile.selectedAvatar?.palette?.name }}
          </p>
        </div>
      </div>
      <div class="kid-stats">
        <div class="stat-item">
          <span class="stat-number">{{ getTotalTasksCount() }}</span>
          <span class="stat-label">Attivit√†</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ getCompletedTasksCount() }}</span>
          <span class="stat-label">Completate</span>
        </div>
      </div>
    </div>

    <!-- HEADER CALENDARIO -->
    <div class="calendar-header">
      <div class="header-top">
        <h1>Calendario famiglia</h1>
      </div>

      <div class="header-bottom">
        <div class="date-title">
          <h2>{{ getDateTitle() }}</h2>
        </div>

        <ion-segment
          class="view-selector"
          [value]="currentView()"
          (ionChange)="onViewChange($event)"
        >
          <ion-segment-button value="now">
            <ion-icon name="time-outline"></ion-icon>
            <ion-label>Ora</ion-label>
          </ion-segment-button>

          <ion-segment-button value="day">
            <ion-icon name="today"></ion-icon>
            <ion-label>Giorno</ion-label>
          </ion-segment-button>

          <ion-segment-button value="week">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>Settimana</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>
    </div>

    <!-- VISTA ORA -->
    <div *ngIf="currentView() === 'now'" class="now-view">
      <ion-card class="day-card now-card">
        <ion-card-header class="day-header now-header">
          <div class="current-time-section">
            <div class="time-emoji">üïí</div>
            <ion-card-title>Adesso</ion-card-title>
            <p class="day-date">
              {{ (getDisplayDays()[0] | date:'EEEE d MMMM':'':'it-IT') }}
            </p>
            <ion-badge class="task-counter" [color]="getNowTaskCountColor()">
              {{ getNowTasks().length }} attivit√†
            </ion-badge>
          </div>
        </ion-card-header>

        <ion-card-content>
          <ng-container *ngIf="getNowTasks().length > 0; else emptyNow">
            <div class="now-task-list">
              <div class="task-wrapper now-task" *ngFor="let task of getNowTasks()">
                <div class="now-task-header">
                  <div class="time-status-badge" [ngClass]="'status-' + task.timeStatus">
                    <ng-container [ngSwitch]="task.timeStatus">
                      <ng-container *ngSwitchCase="'current'">
                        <ion-icon name="play-circle"></ion-icon>
                        <span>ORA</span>
                      </ng-container>
                      <ng-container *ngSwitchCase="'upcoming'">
                        <ion-icon name="time"></ion-icon>
                        <span>{{ formatMinutes(task.minutesFromNow) }}</span>
                      </ng-container>
                      <ng-container *ngSwitchDefault>
                        <ion-icon name="checkmark-circle"></ion-icon>
                        <span>FATTA</span>
                      </ng-container>
                    </ng-container>
                  </div>
                  <div class="task-time-info">
                    {{ task.start | date:'HH:mm':'':'it-IT' }} -
                    {{ task.end   | date:'HH:mm':'':'it-IT' }}
                  </div>
                </div>

                <div class="task-card-content">
                  <app-kid-task-card
                    [task]="task"
                    (doneChange)="onDone($event)"
                  ></app-kid-task-card>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-template #emptyNow>
            <div class="empty-now-message">
              <div class="empty-emoji">üòé</div>
              <p>Nessuna attivit√† in questo momento</p>
              <small>Perfetto momento per una pausa!</small>
            </div>
          </ng-template>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- VISTA GIORNO / SETTIMANA -->
    <div *ngIf="currentView() !== 'now'" class="days-grid" [class.single-day]="currentView() === 'day'">
      <ion-card class="day-card" *ngFor="let d of getDisplayDays()">
        <ion-card-header class="day-header">
          <div class="day-emoji">{{ getDayEmoji(d) }}</div>
          <ion-card-title>{{ d | date:'EEEE':'':'it-IT' }}</ion-card-title>
          <p class="day-date">{{ d | date:'d MMMM':'':'it-IT' }}</p>
          <ion-badge class="task-counter" [color]="getTaskCountColor(d)">
            {{ (lists()[d] || []).length }} attivit√†
          </ion-badge>
        </ion-card-header>

        <ion-card-content>
          <!-- Vista per giorno: raggruppata per bambino -->
          <ng-container *ngIf="currentView() === 'day'; else weekView">
            <ng-container *ngIf="getChildrenWithTasksForDay(d).length > 0; else emptyDay">
              <div class="child-section" *ngFor="let child of getChildrenWithTasksForDay(d)">
                <div class="child-header">
                  <div class="child-avatar-container">
                    <div class="child-avatar">{{ child.avatar }}</div>
                    <div class="child-info">
                      <h4 class="child-name">{{ child.name }}</h4>
                      <p class="child-progress">
                        {{ getCompletedTasksForChild(d, child.id) }}/{{ child.tasks.length }} completate
                      </p>
                    </div>
                  </div>
                </div>

                <div
                  class="child-drop-zone"
                  cdkDropList
                  [cdkDropListData]="child.tasks"
                  (cdkDropListDropped)="drop($event, d)"
                >
                  <div
                    class="task-wrapper child-task"
                    *ngFor="let task of child.tasks"
                    cdkDrag
                    [cdkDragData]="task"
                  >
                    <div class="task-content">
                      <app-kid-task-card
                        [task]="task"
                        (doneChange)="onDone($event)"
                      ></app-kid-task-card>
                      <div class="drag-handle-wrapper" cdkDragHandle>
                        <ion-icon
                          name="reorder-two-outline"
                          class="external-drag-handle"
                        ></ion-icon>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="child.tasks.length === 0" class="empty-child-zone">
                    <ion-icon name="happy-outline"></ion-icon>
                    <p>Nessuna attivit√† per {{ child.name }}</p>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #emptyDay>
              <div class="empty-drop-zone">
                <ion-icon name="calendar-outline"></ion-icon>
                <p>Nessuna attivit√† programmata</p>
              </div>
            </ng-template>
          </ng-container>

          <!-- Vista settimana: lista semplice di task -->
          <ng-template #weekView>
            <div
              class="drop-zone"
              cdkDropList
              [cdkDropListData]="lists()[d] || []"
              (cdkDropListDropped)="drop($event, d)"
            >
              <div
                class="task-wrapper"
                *ngFor="let task of (lists()[d] || [])"
                cdkDrag
                [cdkDragData]="task"
              >
                <div class="task-content">
                  <app-kid-task-card
                    [task]="task"
                    (doneChange)="onDone($event)"
                  ></app-kid-task-card>
                  <div class="drag-handle-wrapper" cdkDragHandle>
                    <ion-icon
                      name="reorder-two-outline"
                      class="external-drag-handle"
                    ></ion-icon>
                  </div>
                </div>
              </div>

              <div *ngIf="(lists()[d] || []).length === 0" class="empty-drop-zone">
                <ion-icon name="calendar-outline"></ion-icon>
                <p>Nessuna attivit√† programmata</p>
              </div>
            </div>
          </ng-template>
        </ion-card-content>
      </ion-card>
    </div>

  </div>
</ion-content>
