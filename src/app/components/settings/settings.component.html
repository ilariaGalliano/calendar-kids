<ion-content class="settings-page">
  <!-- Decorazioni -->
  <div class="floating-decorations">
    <div class="decoration">âš™ï¸</div>
    <div class="decoration">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
    <div class="decoration">ğŸ“‹</div>
    <div class="decoration">â°</div>
  </div>

  <div class="settings-container">
    <!-- Header -->
    <div class="page-header">
      <div class="header-buttons">
        <ion-button fill="clear" (click)="goBack()" class="back-btn">
          â† Indietro
        </ion-button>
        <ion-button fill="outline" color="danger" (click)="logout()" class="logout-btn">
          ğŸšª Logout
        </ion-button>
      </div>
      <h1>âš™ï¸ Impostazioni Famiglia</h1>
      <p>Gestisci routine e task per i tuoi bambini</p>
    </div>

    <!-- Segmenti di navigazione -->
    <ion-segment [(ngModel)]="activeSegment" class="main-segment">
      <ion-segment-button value="children">
        <ion-label>ğŸ‘¶ Bambini</ion-label>
      </ion-segment-button>
      <ion-segment-button value="tasks">
        <ion-label>ğŸ“‹ Task</ion-label>
      </ion-segment-button>
      <ion-segment-button value="routines">
        <ion-label>â° Routine</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Sezione Bambini -->
    @if (activeSegment === 'children') {
    <div class="section-content">
      <ion-card class="kids-card">
        <ion-card-header>
          <ion-card-title>ğŸ‘¶ I Tuoi Bambini</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            @for (child of children(); track child.id) {
            <ion-item class="child-item">
              <ion-avatar slot="start">
                @if (child.avatar) {
                <img [src]="child.avatar" [alt]="child.name">
                } @else {
                <div class="child-avatar">ğŸ§’</div>
                }
              </ion-avatar>
              <ion-label>
                <h2>{{ child.name }}</h2>
                <p>{{ child.age }} anni</p>
              </ion-label>
              <ion-button fill="clear" size="small" (click)="editChild(child)">
                âœï¸
              </ion-button>
              <ion-button fill="clear" size="small" color="danger" (click)="deleteChild(child)">
                ğŸ—‘ï¸
              </ion-button>
            </ion-item>
            }
          </ion-list>

          <ion-button expand="block" fill="outline" (click)="addChild()" class="add-btn">
            â• Aggiungi Bambino
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
    }

    <!-- Sezione Task -->
    @if (activeSegment === 'tasks') {
    <div class="section-content">
      <!-- Filtro categorie -->
      <!-- <ion-segment [(ngModel)]="taskFilter" class="filter-segment">
        <ion-segment-button value="all">
          <ion-label>Tutti</ion-label>
        </ion-segment-button>
      </ion-segment> -->

      <ion-card class="kids-card">
        <ion-card-header>
          <ion-card-title>ğŸ“‹ Libreria Task</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="tasks-grid">
            @for (task of tasks(); track task.id) {
            <div class="task-card" [style.background]="task.color + '20'">
              <div class="task-header">
                <span class="task-emoji">{{ task.emoji }}</span>
                <ion-toggle [checked]="task.isActive" (ionChange)="onToggleTask(task, $event.detail.checked)">
                </ion-toggle>
              </div>
              <h3>{{ task.title }}</h3>
              <p>{{ task.duration }} min</p>
              <div class="task-actions">
                <ion-button fill="clear" size="small" (click)="editTask(task)">
                  âœï¸
                </ion-button>
                <ion-button fill="clear" size="small" color="danger" (click)="deleteTask(task)">
                  ğŸ—‘ï¸
                </ion-button>
              </div>
            </div>
            }
          </div>

          <ion-button expand="block" fill="outline" (click)="addTask()" class="add-btn">
            â• Crea Nuovo Task
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
    }

    <!-- Sezione Routine -->
    @if (activeSegment === 'routines') {
    <div class="section-content">
      @for (child of children(); track child.id) {
      <ion-card class="kids-card">
        <ion-card-header>
          <ion-card-title>
            <div class="routine-header">
              <div class="child-info">
                <span class="child-emoji">ğŸ§’</span>
                <span>Routine di {{ child.name }}</span>
              </div>

              <ion-button fill="clear" size="small" (click)="createRoutine(child.id)">â•</ion-button>
            </div>
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          @for (routine of getRoutinesForChild(child.id); track routine.id) {

          <div class="routine-item">

            <div class="routine-info">
              <h3>{{ routine.name }}</h3>
              <p>â° {{ routine.startTime }}</p>

              <!-- LISTA DEI GIORNI CON I TASK PER OGNI GIORNO -->
              <div class="routine-days-expanded">

                @for (day of routine.days; track day) {

                <div class="day-section">
                  <div class="day-title">
                    ğŸ“… {{ getDayLabel(day) }}
                  </div>

                  <div class="day-tasks">

                    @for (task of getTasksForRoutineDay(routine, day); track task.id) {
                    <div class="day-task-item">
                      <div class="task-left">
                        <span class="task-emoji">{{ task.emoji }}</span>
                        <div>
                          <div class="task-title">{{ task.title }}</div>
                          <div class="task-meta">{{ task.duration }} min â€” ğŸ† {{ task.reward }}</div>
                        </div>
                      </div>

                      <div class="task-actions">
                        <ion-button fill="clear" size="small" (click)="editTask(task)">âœï¸</ion-button>
                        <ion-button fill="clear" size="small" color="danger" (click)="deleteTask(task)">ğŸ—‘ï¸</ion-button>
                      </div>
                    </div>
                    }

                    @empty {
                    <div class="no-tasks">
                      Nessuna attivitÃ  â†’
                      <ion-button size="small" fill="clear" (click)="addTaskRoutine(routine, day)">
                        Aggiungi
                      </ion-button>
                    </div>
                    }

                  </div>
                </div>

                }

              </div>
            </div>

            <div class="routine-actions">
              <ion-toggle [(ngModel)]="routine.isActive" (ionChange)="updateRoutine(routine)"></ion-toggle>
              <ion-button fill="clear" size="small" (click)="editRoutine(routine)">âœï¸</ion-button>
              <ion-button fill="clear" size="small" color="danger" (click)="deleteRoutine(routine)">ğŸ—‘ï¸</ion-button>
            </div>

          </div>

          }

        </ion-card-content>
      </ion-card>
      }

    </div>
    }
  </div>

  <!-- Modal per aggiungere/modificare task -->
  <ion-modal [isOpen]="showTaskModal()" (willDismiss)="closeTaskModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ editingTask() ? 'Modifica Task' : 'Nuovo Task' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeTaskModal()">âœ–ï¸</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <div class="task-form">
          <ion-item>
            <ion-label position="stacked">Emoji</ion-label>
            <ion-input [(ngModel)]="taskForm.emoji" placeholder="ğŸ¯">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nome Task</ion-label>
            <ion-input [(ngModel)]="taskForm.title" placeholder="Es: Lavare i denti">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descrizione</ion-label>
            <ion-textarea [(ngModel)]="taskForm.description" placeholder="Descrizione opzionale">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Durata (minuti)</ion-label>
            <ion-input type="number" [(ngModel)]="taskForm.duration" placeholder="5">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Ricompensa</ion-label>
            <ion-input type="number" [(ngModel)]="taskForm.reward" placeholder="10">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Colore</ion-label>
            <div class="color-picker">
              @for (color of taskColors; track color) {
              <div class="color-option" [class.selected]="taskForm.color === color" [style.background]="color"
                (click)="taskForm.color = color">
              </div>
              }
            </div>
          </ion-item>

          <div class="form-actions">
            <ion-button expand="block" fill="outline" (click)="closeTaskModal()">
              Annulla
            </ion-button>
            <ion-button expand="block" (click)="saveTask()">
              {{ editingTask() ? 'Aggiorna' : 'Crea' }} Task
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- FAB per azioni rapide -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="primary">
      â•
    </ion-fab-button>
  </ion-fab>
</ion-content>